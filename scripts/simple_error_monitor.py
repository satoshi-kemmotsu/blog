#!/usr/bin/env python3
"""
ã‚·ãƒ³ãƒ—ãƒ«ã‚¨ãƒ©ãƒ¼æ¤œå‡ºãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ 
è‡ªå‹•ä¿®æ­£ãªã—ã€é€šçŸ¥ç‰¹åŒ–ç‰ˆ

Author: Claude Code  
Date: 2025-08-10
"""

from flask import Flask, request, jsonify
import json
import logging
import requests
import os
from datetime import datetime
from pathlib import Path

# ãƒ­ã‚°è¨­å®š
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/Users/skem/Himawari/SEO_AUTO_BLOG_PROJECT/logs/simple_error_monitor.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

app = Flask(__name__)

# è¨­å®š
PROJECT_NAME = os.getenv('PROJECT_NAME', 'ãƒ–ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ')
SLACK_WEBHOOK_URL = os.getenv('SLACK_WEBHOOK_URL', '')  # ã‚ªãƒ—ã‚·ãƒ§ãƒ³
DISCORD_WEBHOOK_URL = os.getenv('DISCORD_WEBHOOK_URL', '')  # ã‚ªãƒ—ã‚·ãƒ§ãƒ³

class SimpleErrorAnalyzer:
    """ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ©ãƒ¼æ¤œå‡ºãƒ»åˆ†æ"""
    
    def __init__(self):
        self.common_error_patterns = {
            'ruby_gems': [
                'cannot load such file --',
                'LoadError',
                'Bundler::GemNotFound',
                'Could not find gem'
            ],
            'jekyll': [
                'Liquid syntax error',
                'YAML front matter',
                'Layout does not exist',
                'jekyll build failed'
            ],
            'netlify': [
                'dependency_installation script returned non-zero exit code',
                'Build script returned non-zero exit code',
                'Command failed with exit code'
            ]
        }
    
    def analyze_error(self, error_message, platform="unknown"):
        """ã‚¨ãƒ©ãƒ¼åˆ†æï¼ˆä¿®æ­£ææ¡ˆãªã—ï¼‰"""
        detected_issues = []
        
        error_lower = error_message.lower()
        
        for category, patterns in self.common_error_patterns.items():
            for pattern in patterns:
                if pattern.lower() in error_lower:
                    detected_issues.append({
                        'category': category,
                        'pattern': pattern,
                        'severity': self._get_severity(category),
                        'platform': platform
                    })
        
        return detected_issues
    
    def _get_severity(self, category):
        """ã‚¨ãƒ©ãƒ¼ã®æ·±åˆ»åº¦åˆ¤å®š"""
        severity_map = {
            'ruby_gems': 'HIGH',    # ãƒ“ãƒ«ãƒ‰å®Œå…¨åœæ­¢
            'jekyll': 'MEDIUM',     # ä¸€éƒ¨è¨˜äº‹å½±éŸ¿
            'netlify': 'HIGH'       # ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—
        }
        return severity_map.get(category, 'MEDIUM')

def send_alert(error_data):
    """ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ï¼ˆè¤‡æ•°ãƒãƒ£ãƒ³ãƒãƒ«ï¼‰"""
    
    alert_message = format_alert_message(error_data)
    
    # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ï¼ˆå¿…é ˆï¼‰
    logger.error("ğŸš¨ BUILD ERROR DETECTED ğŸš¨")
    logger.error(alert_message)
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ã‚°ï¼ˆå¿…é ˆï¼‰
    log_detailed_error(error_data)
    
    # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if SLACK_WEBHOOK_URL:
        send_slack_alert(alert_message)
    
    # Discordé€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if DISCORD_WEBHOOK_URL:
        send_discord_alert(alert_message)
    
    # ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ï¼ˆmacOSï¼‰
    send_system_notification(alert_message)

def format_alert_message(error_data):
    """ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•´å½¢"""
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    platform = error_data.get('platform', 'Unknown')
    site_name = error_data.get('site_name', 'Unknown Site')
    error_message = error_data.get('error_message', 'No details')
    admin_url = error_data.get('admin_url', 'N/A')
    
    detected_issues = error_data.get('detected_issues', [])
    
    message = f"""
ğŸš¨ {PROJECT_NAME} - BUILD ERROR ALERT

â° Time: {timestamp}
ğŸŒ Platform: {platform}
ğŸ  Site: {site_name}
ğŸ”— Admin URL: {admin_url}

ğŸ“‹ Error Details:
{error_message}

ğŸ” Detected Issues ({len(detected_issues)}):
"""
    
    for i, issue in enumerate(detected_issues, 1):
        severity_emoji = "ğŸ”´" if issue['severity'] == 'HIGH' else "ğŸŸ¡"
        message += f"{i}. {severity_emoji} {issue['category'].upper()}: {issue['pattern']}\n"
    
    message += f"""
ğŸ’¡ Next Steps:
1. Check the admin panel: {admin_url}
2. Review recent commits for potential issues
3. Run Claude Code for automated diagnosis
4. Check _posts/ for malformed articles

--- Generated by Simple Error Monitor ---
"""
    
    return message.strip()

def log_detailed_error(error_data):
    """è©³ç´°ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›"""
    timestamp = datetime.now().isoformat()
    
    log_entry = {
        'timestamp': timestamp,
        'project': PROJECT_NAME,
        'platform': error_data.get('platform'),
        'site_name': error_data.get('site_name'),
        'error_message': error_data.get('error_message'),
        'admin_url': error_data.get('admin_url'),
        'detected_issues': error_data.get('detected_issues', []),
        'raw_payload': error_data.get('raw_payload')
    }
    
    # JSONå½¢å¼ã§ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
    log_file = Path('/Users/skem/Himawari/SEO_AUTO_BLOG_PROJECT/logs/detailed_errors.json')
    
    try:
        if log_file.exists():
            with open(log_file, 'r', encoding='utf-8') as f:
                logs = json.load(f)
        else:
            logs = []
        
        logs.append(log_entry)
        
        # æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
        if len(logs) > 100:
            logs = logs[-100:]
        
        with open(log_file, 'w', encoding='utf-8') as f:
            json.dump(logs, f, indent=2, ensure_ascii=False)
            
    except Exception as e:
        logger.error(f"è©³ç´°ãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼: {e}")

def send_slack_alert(message):
    """Slacké€šçŸ¥"""
    try:
        payload = {
            "text": message,
            "username": "Error Monitor Bot",
            "icon_emoji": ":warning:"
        }
        
        response = requests.post(SLACK_WEBHOOK_URL, json=payload, timeout=10)
        
        if response.status_code == 200:
            logger.info("âœ… Slacké€šçŸ¥é€ä¿¡æˆåŠŸ")
        else:
            logger.warning(f"âš ï¸ Slacké€šçŸ¥å¤±æ•—: {response.status_code}")
            
    except Exception as e:
        logger.error(f"Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")

def send_discord_alert(message):
    """Discordé€šçŸ¥"""
    try:
        payload = {
            "content": message,
            "username": "Error Monitor"
        }
        
        response = requests.post(DISCORD_WEBHOOK_URL, json=payload, timeout=10)
        
        if response.status_code in [200, 204]:
            logger.info("âœ… Discordé€šçŸ¥é€ä¿¡æˆåŠŸ")
        else:
            logger.warning(f"âš ï¸ Discordé€šçŸ¥å¤±æ•—: {response.status_code}")
            
    except Exception as e:
        logger.error(f"Discordé€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")

def send_system_notification(message):
    """ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ï¼ˆmacOSï¼‰"""
    try:
        # macOSé€šçŸ¥
        os.system(f'''osascript -e 'display notification "{PROJECT_NAME}ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ" with title "Build Error Alert"' ''')
        logger.info("âœ… ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥é€ä¿¡")
        
    except Exception as e:
        logger.error(f"ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")

@app.route('/health')
def health_check():
    """ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
    return jsonify({
        "status": "healthy", 
        "timestamp": datetime.now().isoformat(),
        "project": PROJECT_NAME,
        "mode": "ERROR_DETECTION_ONLY"
    })

@app.route('/netlify-webhook', methods=['POST'])
def netlify_webhook():
    """Netlify Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæ¤œå‡ºå°‚ç”¨ï¼‰"""
    try:
        payload = request.json
        
        # ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®ã¿å‡¦ç†
        if payload.get('state') == 'error':
            
            analyzer = SimpleErrorAnalyzer()
            
            error_data = {
                'platform': 'Netlify',
                'site_name': payload.get('name', 'Unknown'),
                'error_message': payload.get('error_message', 'No error message'),
                'admin_url': payload.get('admin_url', 'N/A'),
                'detected_issues': analyzer.analyze_error(
                    payload.get('error_message', ''), 
                    'netlify'
                ),
                'raw_payload': payload
            }
            
            # ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
            send_alert(error_data)
        
        # æˆåŠŸæ™‚ã¯é™ã‹ã«ãƒ­ã‚°
        elif payload.get('state') == 'ready':
            logger.info(f"âœ… Netlify DeployæˆåŠŸ: {payload.get('name')}")
        
        return jsonify({"status": "processed", "mode": "detection_only"}), 200
        
    except Exception as e:
        logger.error(f"Netlify Webhookã‚¨ãƒ©ãƒ¼: {e}")
        return jsonify({"error": str(e)}), 500

@app.route('/github-webhook', methods=['POST'])  
def github_webhook():
    """GitHub Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæ¤œå‡ºå°‚ç”¨ï¼‰"""
    try:
        payload = request.json
        event_type = request.headers.get('X-GitHub-Event')
        
        logger.info(f"GitHub Event: {event_type}")
        
        # Workflowå¤±æ•—ã®ã¿å‡¦ç†
        if event_type == 'workflow_run' and payload['action'] == 'completed':
            if payload['workflow_run']['conclusion'] == 'failure':
                
                analyzer = SimpleErrorAnalyzer()
                
                error_data = {
                    'platform': 'GitHub Actions',
                    'site_name': payload['repository']['full_name'],
                    'error_message': f"Workflow '{payload['workflow_run']['name']}' failed",
                    'admin_url': payload['workflow_run']['html_url'],
                    'detected_issues': analyzer.analyze_error('workflow failure', 'github'),
                    'raw_payload': payload
                }
                
                # ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
                send_alert(error_data)
        
        return jsonify({"status": "processed", "mode": "detection_only"}), 200
        
    except Exception as e:
        logger.error(f"GitHub Webhookã‚¨ãƒ©ãƒ¼: {e}")
        return jsonify({"error": str(e)}), 500

@app.route('/manual-test', methods=['POST'])
def manual_test():
    """æ‰‹å‹•ãƒ†ã‚¹ãƒˆç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ"""
    try:
        test_data = request.json or {}
        
        analyzer = SimpleErrorAnalyzer()
        
        error_data = {
            'platform': 'Manual Test',
            'site_name': test_data.get('site', 'Test Site'),
            'error_message': test_data.get('error', 'Manual test error'),
            'admin_url': 'N/A',
            'detected_issues': analyzer.analyze_error(
                test_data.get('error', ''), 
                'manual'
            ),
            'raw_payload': test_data
        }
        
        send_alert(error_data)
        
        return jsonify({
            "status": "test_completed",
            "detected_issues": len(error_data['detected_issues'])
        }), 200
        
    except Exception as e:
        logger.error(f"æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    logger.info("ğŸš€ Simple Error Monitorèµ·å‹•")
    logger.info(f"ğŸ“‹ Project: {PROJECT_NAME}")
    logger.info("ğŸ¯ Mode: ERROR DETECTION & ALERT ONLY")
    logger.info("âŒ Auto-fix: DISABLED")
    
    # ãƒãƒ¼ãƒˆ8084ã§èµ·å‹•ï¼ˆç«¶åˆå›é¿ï¼‰
    app.run(host='0.0.0.0', port=8084, debug=True)